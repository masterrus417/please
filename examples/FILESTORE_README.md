<div align="center">
<img src="https://git.main.ecp:5298/pipeline_badge?name=filestore">
<img src="https://git.main.ecp:5298/pipeline_badge?name=filestore&branch=devel">
</div>

# FileStore
Файловое хранилище
/fsapi/v1/..

## Использование   
### Генерация ключей
```
GET /generate   
```
Запросить себе пару ключей, чтобы потом туда добавить файлы функцией /upload или /link.
Необязательный функционал.
Возвращает json   
```
{ 
"fluid":"uuid",
"rigid":"uuid"
}
```
где rigid - ключ хозяина, а fluid - публичный ключ.   
Функциями /upload и /link используется ключ хозяина, rigid.

### Отправка файла  
```
POST /upload   
```
В теле запроса должен содержаться файл, с указанием его имени. 
{"Content-Disposition": "name="file"; filename="example.txt""}
В body form-data  {"file": FILE}

Возвращает json   
```
{ 
"fluid":"uuid",
"rigid":"uuid"
}
```
где rigid - ключ хозяина, а fluid - публичный ключ.    
Оба ключа могут использоваться для получения информации или скачивания файла.   
Для удаления файла или получения бОльшей информации используется ключ хозяина rigid.   
Будьте внимательны и осторожны, предоставляйте правильный ключ пользователям.   

### Отправка файла по ключу
```
POST /upload/{rigid}   
```
Параметром является заранее сгенерированный rigid (см. /generate). 
Именно в него будет помещен приложенный файл. Внимание! Загрузить файл в указаный путь получится только один раз.
Последующие вызовы этой же функции с тем же параметром будут возвращать ошибку 400.
В остальном аналогично функции /upload.

Возвращает json   
```
{ 
"fluid":"uuid",
"rigid":"uuid"
}
```
### Создание связей
```
POST /link
```
Файлы можно связать друг с другом для того, чтобы по uuid можно было получить информацию или скачать сразу несколько файлов.
Для этого сначала нужно загрузить файлы функцией /upload или /upload{rigid}.
Затем передать в link в body form-data структуру
```
{
"rigids": ["uuid","uuid",],
"title":"Заголовок связки"
}
```
Все указанные файлы будут объединены в связку и будут как доступны по  fluid и  rigid все вместе, так и по отдельности останутся доступны по своим личным uuid. 
Title будет отображаться в поле filename, когда будут запрашивать информацию по этой связке.
Указанные в списке fluid будут проигнорированы.
Внимание! Если в список соединяемых файлов попадет файл, который в свою очередь является результатом соединения файлов,
то все привязанные к нему файлы войдут в новую привязку.

Если в список соединяемых файлов попадет файл, который уже находился в связке, то он будет из нее вырван и
добавлен в новую связку (rigid это всегда ультимативные права на файл).

Возвращает json   
```
{ 
"fluid":"uuid",
"rigid":"uuid"
}
```
С возвращенным заголовочным файлом доступны все те же действия - просмотр, получение, удаление.

### Создание связей по ключу
```
POST /link/{rigid}
```
Параметром является заранее сгенерированный rigid (см. /generate). 
Именно в него будет помещена связь файлов. Внимание! Создать связь в указаный путь получится только один раз.
Последующие вызовы этой же функции с тем же параметром будут возвращать ошибку 400.
В остальном аналогично функции /link.

Возвращает json   
```
{ 
"fluid":"uuid",
"rigid":"uuid"
}

```

### Получение информации   
```
GET /info/{uuid}   
```
Возвращает json, содержащий информацию о файле.   
В случае, если указанный uuid указывает на список файлов (см. /link), список "files" будет содержать аналогичную информацию о всех входящих в список файлах.  
При передаче публичного ключа (fluid) возвращает только базовую информацию о файле.
```
{
    "fluid": "ce1e9fd5-80f9-423d-b634-a660885f4f24",
    "name": "example.txt",
    "size": 19254,
    "ts_created": "2023-08-02T15:46:08.397231+05:00",
    "user_created": "z00000",
    "is_file": true,
    "files"=[]
}
```

При передаче мастер-ключа (rigid) возвращает расширенную информацию о файле, а также журнал взаимодействия с файлом (загрузка, получение, удаление)   
```
{
    "fluid": "ce1e9fd5-80f9-423d-b634-a660885f4f24",
    "rigid": "9a808318-da90-44a5-b035-a1b65feea1e9",
    "name": "example.txt",
    "size": 19254,
    "checksum": "AFCBJHASDFHBKADF",
    "ts_created": "2023-08-02T15:46:08.397231+05:00",
    "user_created": "z00000",
    "ts_deleted": null,
    "user_deleted": null,
    "ts_cleared": null,
    "logs": [
        {
            "type": "upload",
            "message": "1 msec,079-7955.eci.local:8986",
            "user_log": "z00000",
            "ts_log": "2023-08-02T15:52:17.792913+05:00"
        }
    ],
    "is_file": true,
    "files"=[]
}

```

### Получение файла   
```
GET /download/{uuid}   
```
Возвращает файл. Для получения может использоваться как мастер-ключ, так и публичный.   
[TO BE DONE] Если под uuid скрывалась связка файлов, они будут скачаны один за другим.

### Удаление файла   
```
POST /delete 
```
Помечает файл на удаление. Для удаления может использоваться только мастер-ключ. 
Ключ от связки пометит на удаление все входящие в нее файлы.   
Требуется передать в body form-data структуру
```
{
"rigid": "uuid"
}
```
Очистка файла из файловой системы произойдет при срабатывании процедуры cleaner.   
При этом основная информация о файле и журнал останется в системе для истории.   

### Положить в сундук   
```
POST /stash 
```
Позволяет не хранить у себя отдельные ключи, а заказывать хранение файлов, основываясь на своем составном ключе
[prog_code, doc_id, info]. Можно запросить сундук, передать полученную ссылку на веб приложение файлового обмена пользователю, в котором могут быть произведены разрешенные действия.
Если сундук уже однажды запрашивался, то для него был сгенерирован ключ, его требуется хранить у себя. Когда вновь
требуется открыть сундук, требуется передать сохраненный ключ.
Требуется передать в body form-data структуру
```
 {
    "prog_code": "WC03P",
    "doc_id": 3123,
    "info": "Положение",
    "mode": "read",
    "key": "MYBEAUTIFULKEY",
 }
 ```

где:
- prog_code - произвольный код программы
- doc_id  - произвольный идентификатор сущности внешней системы, обязательно BIGINT
- info - произвольный (в том числе пустой) строковый идентификатор сущности внешней системы. Например, сундуки  [WC03P, 3123, "Приказ"], [WC03P, 3123, ""] и [WC03P, 3123, "Приложение"] будут различаться.
- mode содержит "edit", "read", или "" (по-умолчанию "read"), используется для генерации ссылки.

Необязательный параметр:
- key содержит строковый ключ для этого сундука. При создании нового сундука, значение будет проигнорировано и сгенерировано приложением. При существовании уже сундука, и неправильном ключе - вернет ошибку.

Возвращает json
```
{
    "url":"http://filestore_web_app_url/TEMPORARY_PART",
    "stash":"TEMPORARY_PART",
    "key":"MYBEAUTIFULKEY",
    "mode":"read",
    "files": [
        {
            "fluid": "ce1e9fd5-80f9-423d-b634-a660885f4f24",
            "name": "example.txt",
            "size": 19254,
            "ts": "2023-08-02T15:46:08.397231+05:00",
            "author": "z00000",
        },
    ]
}
```

url - **_временная_** ссылка для открытия сундука в веб приложении файлового хранилища в соответствующем режиме mode.
key - можно использовать отдельно в /resolve, чтобы получить временные fluid и rigid для взаимодействия через api.
files - прямые ссылки на файлы, которые лежат в сундуке. Структура аналогична /info. В случае режима read содержит только публичные ключи, в случае режима edit содержит в том числе и master ключи. 

### Открыть сундук   
```
GET /resolve/{TEMPORARY_URL} 
```
Открывает сундук по **_временной_** ссылке.
По истечении определенного времени (по-умолчанию час), ссылка будет возвращать 404, а временные master и public ключи, которые возвращает запрос, станут недействительными.

Возвращает json
```
 {
    "mode":"read",
    "fluid": "uuid",
    "rigid": "uuid",
 }
 ```
rigid может быть пустым, если режим открытия сундука _mode_ был _read_ (только для чтения).

